import { NoteLinkDefinition, Resource } from '../model/note';
import { Range } from '../model/range';
import { createMarkdownReferences } from '../services/markdown-provider';
import { FoamWorkspace } from '../model/workspace';
import { TextEdit } from '../services/text-edit';
import { getLinkDefinitions } from '../services/markdown-parser';

export const LINK_REFERENCE_DEFINITION_HEADER = `[//begin]: # "Autogenerated link references for markdown compatibility"`;
export const LINK_REFERENCE_DEFINITION_FOOTER = `[//end]: # "Autogenerated link references"`;

export const generateLinkReferences = async (
  note: Resource,
  currentNoteText: string,
  eol: string,
  workspace: FoamWorkspace,
  includeExtensions: boolean
): Promise<TextEdit[]> => {
  if (!note) {
    return [];
  }

  const lines = currentNoteText.split(eol);
  const nLines = lines.length;

  const updatedWikilinkDefinitions = createMarkdownReferences(
    workspace,
    note,
    includeExtensions
  );

  const existingWikilinkDefinitions = getLinkDefinitions(currentNoteText);

  const toAddWikilinkDefinitions = updatedWikilinkDefinitions.filter(
    newDef =>
      !existingWikilinkDefinitions.some(
        existingDef => existingDef.label === newDef.label
      )
  );
  const toRemovedWikilinkDefinitions = existingWikilinkDefinitions.filter(
    existingDef =>
      !updatedWikilinkDefinitions.some(
        newDef => newDef.label === existingDef.label
      )
  );

  const edits: TextEdit[] = [];

  // Remove old definitions
  for (const def of toRemovedWikilinkDefinitions) {
    edits.push({ range: def.range, newText: '' });
  }

  // Add new definitions
  if (toAddWikilinkDefinitions.length > 0) {
    // find the last non-empty line to append the definitions after it
    const lastLineIndex = nLines - 1;
    let insertLineIndex = lastLineIndex;
    while (insertLineIndex > 0 && lines[insertLineIndex].trim() === '') {
      insertLineIndex--;
    }

    const definitions = toAddWikilinkDefinitions.map(def =>
      NoteLinkDefinition.format(def)
    );
    const text = eol + eol + definitions.join(eol) + eol;

    edits.push({
      range: Range.create(
        insertLineIndex,
        lines[insertLineIndex].length,
        lastLineIndex,
        lines[lastLineIndex].length
      ),
      newText: text,
    });
  }

  return edits;
};
